{
    "title": "us-patent-phrase-to-phrase-matching",
    "steps": [
        {
            "text": "<span class='prompt'>ml-master@ai4ai:~$</span> python ml_master.py --task us-patent-phrase-to-phrase-matching --time-limit 12h",
            "delay": 200
        },
        {
            "text": "<span class='info'>[INFO]</span>: Starting run \"us-patent-phrase-to-phrase-matching\"",
            "delay": 200
        },
        {
            "text": "<span class='prompt'>ml-master@ai4ai:~$</span> ",
            "delay": 200
        }
    ],
    "code": "<span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd\n<span class=\"keyword\">import</span> torch\n<span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np\n<span class=\"keyword\">from</span> torch.utils.data <span class=\"keyword\">import</span> Dataset, DataLoader\n<span class=\"keyword\">from</span> transformers <span class=\"keyword\">import</span> (\n    AutoTokenizer,\n    AutoModelForSequenceClassification,\n    AdamW,\n    get_linear_schedule_with_warmup,\n)\n<span class=\"keyword\">from</span> sklearn.model_selection <span class=\"keyword\">import</span> train_test_split\n<span class=\"keyword\">from</span> scipy.stats <span class=\"keyword\">import</span> pearsonr\n<span class=\"keyword\">import</span> os\n\nos.makedirs(<span class=\"string\">&quot;</span><span class=\"string\">./submission</span><span class=\"string\">&quot;</span>, exist_ok=<span class=\"keyword\">True</span>)\n\n<span class=\"comment\"># Use full context codes from dataset (verified all exist in CPC_CLASS_TITLES)</span>\nCPC_CLASS_TITLES = {\n    <span class=\"string\">&quot;</span><span class=\"string\">A01</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Agriculture; forestry; animal husbandry</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">A61</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Medical or veterinary science; hygiene</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B82</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Nanotechnology</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C07</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Organic chemistry</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C08</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Organic macromolecular compounds</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G01</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Measuring; testing</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G06</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Computing; calculating; counting</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">H01</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Basic electric elements</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">H04</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Electric communication technique</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">Y02</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Climate change mitigation technologies</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">A21</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Baking; edible doughs</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">A22</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Butchering; meat treatment</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">A23</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Foods or foodstuffs</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">A24</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Tobacco; cigars; cigarettes</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B01</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Physical or chemical processes or apparatus</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B02</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Crushing, pulverizing, or disintegrating</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B03</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Separation of solid materials</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B05</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Spraying or atomizing</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B06</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Generating or transmitting mechanical vibrations</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B07</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Separating solids from solids</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B08</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Cleaning</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B09</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Disposal of solid waste</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B21</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Metal working without essentially removing material</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B22</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Casting; powder metallurgy</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B23</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Machine tools; metal-working not otherwise provided for</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B24</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Grinding; polishing</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B25</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Hand tools; portable power-driven tools</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B26</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Hand cutting tools; cutting; severing</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B27</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Working or preserving wood</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B28</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Working cement, clay, or stone</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B29</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Working plastics; working substances in a plastic state</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B30</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Presses</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B31</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Making paper articles; working paper</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B32</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Layered products</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B41</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Printing; lining machines; typewriters; stamps</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B42</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Bookbinding; albums; files; special printed matter</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B43</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Writing or drawing implements; bureau accessories</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B44</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Decorative arts</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B60</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Vehicles in general</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B61</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Railways</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B62</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Land vehicles for travelling otherwise than on rails</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B63</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Ships or other waterborne vessels</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B64</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Aircraft; aviation; cosmonautics</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B65</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Conveying; packing; storing</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B66</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Hoisting; lifting; hauling</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B67</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Opening or closing bottles, jars or similar containers</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">B68</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Saddlery; upholstery</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C01</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Inorganic chemistry</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C02</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Treatment of water, waste water, sewage, or sludge</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C03</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Glass; mineral or slag wool</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C04</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Cements; concrete; artificial stone</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C05</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Fertilisers; manufacture thereof</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C06</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Explosives; matches</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C09</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Dyes; paints; polishes; natural resins; adhesives</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C10</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Petroleum, gas or coke industries; fuels</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C11</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Animal or vegetable oils, fats, fatty substances</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C12</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Biochemistry; beer; spirits; wine; vinegar; microbiology</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C13</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Sugar industry</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C14</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Skins; hides; pelts; leather</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C21</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Metallurgy of iron</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C22</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Metallurgy; ferrous or non-ferrous alloys</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C23</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Coating metallic material</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C25</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Electrolytic or electrophoretic processes</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">C30</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Crystal growth</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">D01</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Natural or artificial threads or fibers</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">D02</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Yarns; mechanical finishing of yarns or ropes</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">D03</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Weaving</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">D04</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Braiding; lace-making; knitting</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">D05</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Sewing; embroidering; tufting</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">D06</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Treatment of textiles or the like</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">D07</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Ropes; cables other than electric</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">D21</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Paper-making; production of cellulose</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">E01</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Construction of roads, railways, or bridges</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">E02</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Hydraulic engineering; foundations; soil-shifting</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">E03</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Water supply; sewerage</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">E04</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Building</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">E05</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Locks; keys; window or door fittings</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">E06</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Doors, windows, shutters, or roller blinds</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">E21</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Earth or rock drilling; mining</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F01</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Machines or engines in general</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F02</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Combustion engines</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F03</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Machines or engines for liquids</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F04</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Positive-displacement machines for liquids</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F15</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Fluid-pressure actuators; hydraulics or pneumatics</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F16</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Engineering elements or units</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F17</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Storing or distributing gases or liquids</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F21</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Lighting</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F22</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Steam generation</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F23</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Combustion apparatus</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F24</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Heating; ranges; ventilating</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F25</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Refrigeration or cooling</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F26</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Drying</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F27</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Furnaces; kilns; ovens</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F28</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Heat exchange in general</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F41</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Weapons</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">F42</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Ammunition; blasting</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G02</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Optics</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G03</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Photography; cinematography</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G04</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Horology</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G05</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Controlling; regulating</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G07</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Checking-devices</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G08</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Signalling</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G09</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Educating; cryptography; display</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G10</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Musical instruments; acoustics</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G11</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Information storage</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G12</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Instrument details</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G16</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Information and communication technology</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">G21</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Nuclear physics; nuclear engineering</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">H02</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Generation, conversion, or distribution of electric power</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">H03</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Basic electronic circuitry</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">H05</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Electric techniques not otherwise provided for</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">Y04</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Information or communication technologies</span><span class=\"string\">&quot;</span>,\n    <span class=\"string\">&quot;</span><span class=\"string\">Y10</span><span class=\"string\">&quot;</span>: <span class=\"string\">&quot;</span><span class=\"string\">Technical subjects covered by former USPC</span><span class=\"string\">&quot;</span>,\n}\n\n<span class=\"comment\"># Load data</span>\ntrain_df = pd.read_csv(<span class=\"string\">&quot;</span><span class=\"string\">./input/train.csv</span><span class=\"string\">&quot;</span>)\ntest_df = pd.read_csv(<span class=\"string\">&quot;</span><span class=\"string\">./input/test.csv</span><span class=\"string\">&quot;</span>)\ntrain_df, val_df = train_test_split(train_df, test_size=<span class=\"number\">0.1</span>, random_state=<span class=\"number\">42</span>)\n\n<span class=\"comment\"># Model configuration</span>\nmodel_name = <span class=\"string\">&quot;</span><span class=\"string\">microsoft/deberta-v3-large</span><span class=\"string\">&quot;</span>\ntokenizer = AutoTokenizer.from_pretrained(model_name)\n\n\n<span class=\"keyword\">class</span> <span class=\"class\">PatentDataset</span>(Dataset):\n    <span class=\"keyword\">def</span> <span class=\"function\">__init__</span>(self, df, tokenizer, max_length=<span class=\"number\">512</span>):\n        self.df = df\n        self.tokenizer = tokenizer\n        self.max_length = max_length\n\n    <span class=\"keyword\">def</span> <span class=\"function\">__len__</span>(self):\n        <span class=\"keyword\">return</span> len(self.df)\n\n    <span class=\"keyword\">def</span> <span class=\"function\">__getitem__</span>(self, idx):\n        row = self.df.iloc[idx]\n        context_code = row[<span class=\"string\">&quot;</span><span class=\"string\">context</span><span class=\"string\">&quot;</span>]\n        class_title = CPC_CLASS_TITLES.get(\n            context_code, <span class=\"string\">&quot;</span><span class=\"string\">General technology</span><span class=\"string\">&quot;</span>\n        )  <span class=\"comment\"># Use full context code</span>\n        text = <span class=\"string\">f</span><span class=\"string\">&quot;</span><span class=\"string\">{</span>row[<span class=\"string\">&#x27;</span><span class=\"string\">anchor</span><span class=\"string\">&#x27;</span>]<span class=\"string\">}</span><span class=\"string\"> [SEP] </span><span class=\"string\">{</span>row[<span class=\"string\">&#x27;</span><span class=\"string\">target</span><span class=\"string\">&#x27;</span>]<span class=\"string\">}</span><span class=\"string\"> [SEP] Context: </span><span class=\"string\">{</span>class_title<span class=\"string\">}</span><span class=\"string\"> (</span><span class=\"string\">{</span>context_code<span class=\"string\">}</span><span class=\"string\">)</span><span class=\"string\">&quot;</span>\n\n        inputs = self.tokenizer(\n            text,\n            max_length=self.max_length,\n            padding=<span class=\"string\">&quot;</span><span class=\"string\">max_length</span><span class=\"string\">&quot;</span>,\n            truncation=<span class=\"keyword\">True</span>,\n            return_tensors=<span class=\"string\">&quot;</span><span class=\"string\">pt</span><span class=\"string\">&quot;</span>,\n        )\n        inputs = {k: v.squeeze(<span class=\"number\">0</span>) <span class=\"keyword\">for</span> k, v in inputs.items()}\n        <span class=\"keyword\">if</span> <span class=\"string\">&quot;</span><span class=\"string\">score</span><span class=\"string\">&quot;</span> in row:\n            inputs[<span class=\"string\">&quot;</span><span class=\"string\">labels</span><span class=\"string\">&quot;</span>] = torch.tensor(row[<span class=\"string\">&quot;</span><span class=\"string\">score</span><span class=\"string\">&quot;</span>], dtype=torch.float)\n        <span class=\"keyword\">return</span> inputs\n\n\n<span class=\"comment\"># Initialize model</span>\nmodel = AutoModelForSequenceClassification.from_pretrained(model_name, num_labels=<span class=\"number\">1</span>)\ndevice = torch.device(<span class=\"string\">&quot;</span><span class=\"string\">cuda</span><span class=\"string\">&quot;</span> <span class=\"keyword\">if</span> torch.cuda.is_available() <span class=\"keyword\">else</span> <span class=\"string\">&quot;</span><span class=\"string\">cpu</span><span class=\"string\">&quot;</span>)\nmodel.to(device)\n\n<span class=\"comment\"># Data loaders</span>\ntrain_dataset = PatentDataset(train_df, tokenizer)\nval_dataset = PatentDataset(val_df, tokenizer)\ntrain_loader = DataLoader(train_dataset, batch_size=<span class=\"number\">8</span>, shuffle=<span class=\"keyword\">True</span>, num_workers=<span class=\"number\">4</span>)\nval_loader = DataLoader(val_dataset, batch_size=<span class=\"number\">16</span>, shuffle=<span class=\"keyword\">False</span>, num_workers=<span class=\"number\">4</span>)\n\n<span class=\"comment\"># Training setup</span>\noptimizer = AdamW(model.parameters(), lr=<span class=\"number\">2e-5</span>, weight_decay=<span class=\"number\">0.01</span>)\ntotal_steps = len(train_loader) * <span class=\"number\">10</span>\nscheduler = get_linear_schedule_with_warmup(\n    optimizer, num_warmup_steps=<span class=\"number\">0.1</span> * total_steps, num_training_steps=total_steps\n)\n\nbest_score = -<span class=\"number\">1</span>\n<span class=\"keyword\">for</span> epoch in range(<span class=\"number\">10</span>):\n    model.train()\n    total_loss = <span class=\"number\">0</span>\n    <span class=\"keyword\">for</span> batch in train_loader:\n        inputs = {k: v.to(device) <span class=\"keyword\">for</span> k, v in batch.items() <span class=\"keyword\">if</span> k != <span class=\"string\">&quot;</span><span class=\"string\">labels</span><span class=\"string\">&quot;</span>}\n        labels = batch.get(<span class=\"string\">&quot;</span><span class=\"string\">labels</span><span class=\"string\">&quot;</span>, <span class=\"keyword\">None</span>)\n        <span class=\"keyword\">if</span> labels is not <span class=\"keyword\">None</span>:\n            labels = labels.to(device)\n\n        outputs = model(**inputs, labels=labels)\n        loss = outputs.loss\n        loss.backward()\n\n        torch.nn.utils.clip_grad_norm_(model.parameters(), <span class=\"number\">1.0</span>)\n        optimizer.step()\n        scheduler.step()\n        optimizer.zero_grad()\n        total_loss += loss.item()\n\n    <span class=\"comment\"># Validation</span>\n    model.eval()\n    val_preds, val_labels = [], []\n    <span class=\"keyword\">with</span> torch.no_grad():\n        <span class=\"keyword\">for</span> batch in val_loader:\n            inputs = {k: v.to(device) <span class=\"keyword\">for</span> k, v in batch.items() <span class=\"keyword\">if</span> k != <span class=\"string\">&quot;</span><span class=\"string\">labels</span><span class=\"string\">&quot;</span>}\n            labels = batch.get(<span class=\"string\">&quot;</span><span class=\"string\">labels</span><span class=\"string\">&quot;</span>, <span class=\"keyword\">None</span>)\n            <span class=\"keyword\">if</span> labels is not <span class=\"keyword\">None</span>:\n                val_labels.extend(labels.cpu().numpy())\n\n            outputs = model(**inputs)\n            preds = outputs.logits.squeeze().cpu().numpy()\n            val_preds.extend(preds)\n\n    pearson_corr = pearsonr(val_preds, val_labels)[<span class=\"number\">0</span>]\n    print(\n        <span class=\"string\">f</span><span class=\"string\">&quot;</span><span class=\"string\">Epoch </span><span class=\"string\">{</span>epoch+<span class=\"number\">1</span><span class=\"string\">}</span><span class=\"string\"> | Train Loss: </span><span class=\"string\">{</span>total_loss/len(train_loader)<span class=\"string\">:</span><span class=\"string\">.4f</span><span class=\"string\">}</span><span class=\"string\"> | Val Pearson: </span><span class=\"string\">{</span>pearson_corr<span class=\"string\">:</span><span class=\"string\">.4f</span><span class=\"string\">}</span><span class=\"string\">&quot;</span>\n    )\n\n    <span class=\"keyword\">if</span> pearson_corr &gt; best_score:\n        best_score = pearson_corr\n        torch.save(model.state_dict(), <span class=\"string\">&quot;</span><span class=\"string\">./working/best_model.pt</span><span class=\"string\">&quot;</span>)\n    <span class=\"keyword\">else</span>:\n        print(<span class=\"string\">&quot;</span><span class=\"string\">Early stopping triggered</span><span class=\"string\">&quot;</span>)\n        <span class=\"keyword\">break</span>\n\n<span class=\"comment\"># Generate predictions</span>\nmodel.load_state_dict(torch.load(<span class=\"string\">&quot;</span><span class=\"string\">./working/best_model.pt</span><span class=\"string\">&quot;</span>))\ntest_dataset = PatentDataset(test_df, tokenizer)\ntest_loader = DataLoader(test_dataset, batch_size=<span class=\"number\">16</span>, shuffle=<span class=\"keyword\">False</span>, num_workers=<span class=\"number\">4</span>)\ntest_preds = []\n\nmodel.eval()\n<span class=\"keyword\">with</span> torch.no_grad():\n    <span class=\"keyword\">for</span> batch in test_loader:\n        inputs = {k: v.to(device) <span class=\"keyword\">for</span> k, v in batch.items()}\n        outputs = model(**inputs)\n        preds = outputs.logits.squeeze().cpu().numpy()\n        test_preds.extend(preds)\n\n<span class=\"comment\"># Post-process and save</span>\ntest_preds = np.clip(test_preds, <span class=\"number\">0.0</span>, <span class=\"number\">1.0</span>)\nsubmission = pd.DataFrame({<span class=\"string\">&quot;</span><span class=\"string\">id</span><span class=\"string\">&quot;</span>: test_df[<span class=\"string\">&quot;</span><span class=\"string\">id</span><span class=\"string\">&quot;</span>], <span class=\"string\">&quot;</span><span class=\"string\">score</span><span class=\"string\">&quot;</span>: test_preds})\nsubmission.to_csv(<span class=\"string\">&quot;</span><span class=\"string\">./submission/submission.csv</span><span class=\"string\">&quot;</span>, index=<span class=\"keyword\">False</span>)\nprint(<span class=\"string\">f</span><span class=\"string\">&quot;</span><span class=\"string\">Final Validation Pearson Correlation: </span><span class=\"string\">{</span>best_score<span class=\"string\">:</span><span class=\"string\">.4f</span><span class=\"string\">}</span><span class=\"string\">&quot;</span>)\n"
}